name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

  workflow_dispatch:
    inputs:
      targets:
        description: "Docker Bake targets to build (e.g., 'node-25', '25-alpine', 'all')"
        required: false
        type: string
        default: "all"
      force_push:
        description: "Force push images even on PR"
        required: false
        type: boolean
        default: false

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      targets: ${{ steps.detect.outputs.targets }}
      should-build: ${{ steps.detect.outputs.should-build }}
      changed-files: ${{ steps.detect.outputs.changed-files }}
    steps:
      - name: Check Out Repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.x"

      - name: Detect changes and determine targets
        id: detect
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            targets="${{ inputs.targets }}"
            should_build="true"
            changed_files="manual"
            echo "Manual dispatch - building targets: $targets"
          else
            # For PRs, ensure we have the base branch
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              git fetch origin ${{ github.event.pull_request.base.ref }}:origin/${{ github.event.pull_request.base.ref }}
            fi

            # Use the Python script to detect changes
            output=$(python3 scripts/generate-bake.py --detect-changes)
            changed_files=$(echo "$output" | grep "CHANGED_FILES=" | cut -d'=' -f2-)
            targets=$(echo "$output" | grep "TARGETS=" | cut -d'=' -f2-)

            if [ "$targets" = "none" ]; then
              should_build="false"
              echo "No buildable changes detected, skipping build"
            else
              should_build="true"
              echo "Building targets: $targets"
            fi
          fi

          echo "targets=$targets" >> $GITHUB_OUTPUT
          echo "should-build=$should_build" >> $GITHUB_OUTPUT
          echo "changed-files=$changed_files" >> $GITHUB_OUTPUT

  build:
    needs: detect-changes
    if: always() && needs.detect-changes.outputs.should-build != 'false'
    uses: ./.github/workflows/build.yaml
    with:
      targets: ${{ needs.detect-changes.outputs.targets }}
      push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    secrets:
      docker-hub-access-token: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

  commit-bake-changes:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: detect-changes
    steps:
      - name: Check Out Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check last commit author
        id: check-author
        run: |
          last_author=$(git log -1 --pretty=format:'%an')
          if [ "$last_author" = "Bake Generator" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Last commit was by Bake Generator, skipping auto-update"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Last commit by: $last_author"
          fi

      - name: Set up Python
        if: steps.check-author.outputs.skip == 'false'
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Generate Docker Bake configuration
        if: steps.check-author.outputs.skip == 'false'
        run: python3 scripts/generate-bake.py

      - name: Check if docker-bake.hcl changed
        if: steps.check-author.outputs.skip == 'false'
        id: bake-changes
        run: |
          if git diff --quiet docker-bake.hcl; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit updated docker-bake.hcl
        if: steps.check-author.outputs.skip == 'false' && steps.bake-changes.outputs.changed == 'true'
        run: |
          git config --local user.email "bake-generator@github.com"
          git config --local user.name "Bake Generator"
          git add docker-bake.hcl
          git commit -m "chore: update docker-bake.hcl [skip ci]"
          git push

  summary:
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: always()
    steps:
      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.should-build }}" = "true" ]; then
            echo "âœ… **Build triggered**" >> $GITHUB_STEP_SUMMARY
            echo "- **Targets**: \`${{ needs.detect-changes.outputs.targets }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Push**: \`${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || inputs.force_push }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Trigger**: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY

            if [ "${{ needs.build.result }}" = "success" ]; then
              echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.build.result }}" = "failure" ]; then
              echo "- **Status**: âŒ Failed" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.build.result }}" = "skipped" ]; then
              echo "- **Status**: â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Status**: ðŸŸ¡ ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸ **Build skipped** - No relevant changes detected" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changed Files" >> $GITHUB_STEP_SUMMARY
          changed="${{ needs.detect-changes.outputs.changed-files }}"
          if [ "$changed" = "none" ]; then
            echo "No Dockerfiles or scripts changed" >> $GITHUB_STEP_SUMMARY
          elif [ "$changed" = "all" ]; then
            echo "Manual trigger - building all targets" >> $GITHUB_STEP_SUMMARY
          else
            echo "```" >> $GITHUB_STEP_SUMMARY
            echo "$changed" | tr ',' '\n' >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          fi
